<app-loading [visible]="isLoading"></app-loading>

<h3>Crear Pedido</h3>

<form [formGroup]="form" class="form-container">
  <div class="form-fields">

    <app-customer-form-field [control]="this.form.controls.customer" [isRequired]="true"
      (customerSelected)="onCustomerSelected($event)"></app-customer-form-field>

    <mat-form-field appearance="outline">
      <mat-label>Observación</mat-label>
      <input matInput placeholder="Observación..." formControlName="observation">
    </mat-form-field>

    <app-restaurant-form-field [control]="this.form.controls.restaurantId"
      [isRequired]="true"></app-restaurant-form-field>
  </div>

  <h4>Pedido actual</h4>

  <div formArrayName="orderItems" class="table-container">
    <table mat-table [dataSource]="dataSourceProducts" class="mat-elevation-z8 mat-table-responsive">

      <ng-container matColumnDef="product">
        <th mat-header-cell *matHeaderCellDef>Producto</th>
        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
          <app-product-form-field [control]="getProductControl(i)" [isRequired]="true"
            (productSelected)="onProductSelected(i, $event)"
            [restaurantId]="form.controls.restaurantId.value"></app-product-form-field>
        </td>
        <td mat-footer-cell *matFooterCellDef> Total </td>
      </ng-container>

      <ng-container matColumnDef="quantity">
        <th mat-header-cell *matHeaderCellDef>Cantidad</th>
        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
          <mat-form-field appearance="outline">
            <input matInput min="1" required type="number" formControlName="quantity" />
          </mat-form-field>
        </td>
        <td mat-footer-cell *matFooterCellDef>{{ totalProductsQuantity }}</td>
      </ng-container>

      <ng-container matColumnDef="unitPrice">
        <th mat-header-cell *matHeaderCellDef>Precio Unitario</th>
        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
          <mat-form-field appearance="outline">
            <input matInput readonly min="0.1" type="number" formControlName="unitPrice" />
          </mat-form-field>
        </td>
        <td mat-footer-cell *matFooterCellDef></td>
      </ng-container>

      <ng-container matColumnDef="price">
        <th mat-header-cell *matHeaderCellDef>Precio</th>
        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
          <mat-form-field appearance="outline">
            <input matInput readonly min="0.1" type="number" formControlName="price" />
          </mat-form-field>
        </td>
        <td mat-footer-cell *matFooterCellDef>{{ totalProductsPrice | currency:'S/.':'symbol' }}</td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let row; let i = index">
          @if (orderItems.length > 1) {
          <button mat-icon-button color="warn" (click)="removeProductItem(i)">
            <mat-icon>delete</mat-icon>
          </button>
          }
          @if (i === orderItems.length - 1) {
          <button mat-icon-button color="primary" (click)="addProductItem()" [disabled]="!row.valid">
            <mat-icon>add</mat-icon>
          </button>
          }
        </td>
        <td mat-footer-cell *matFooterCellDef></td>

      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumnsProducts"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumnsProducts;"></tr>
      <tr mat-footer-row *matFooterRowDef="displayedColumnsProducts"></tr>

    </table>
  </div>

  <div formArrayName="orderPromotions" class="table-container">
    <table mat-table [dataSource]="dataSourcePromotions" class="mat-elevation-z8 mat-table-responsive">

      <ng-container matColumnDef="promotion">
        <th mat-header-cell *matHeaderCellDef>Promoción</th>
        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
          <app-promotion-form-field [control]="getPromotionControl(i)" [isRequired]="true"
            (promotionSelected)="onPromotionSelected(i, $event)"
            [restaurantId]="form.controls.restaurantId.value"></app-promotion-form-field>
        </td>
        <td mat-footer-cell *matFooterCellDef> Total </td>
      </ng-container>

      <ng-container matColumnDef="quantity">
        <th mat-header-cell *matHeaderCellDef>Cantidad</th>
        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
          <mat-form-field appearance="outline">
            <input matInput min="1" required type="number" formControlName="quantity" />
          </mat-form-field>
        </td>
        <td mat-footer-cell *matFooterCellDef>{{ totalPromotionsQuantity }}</td>
      </ng-container>

      <ng-container matColumnDef="unitPrice">
        <th mat-header-cell *matHeaderCellDef>Precio Unitario</th>
        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
          <mat-form-field appearance="outline">
            <input matInput readonly min="0.1" type="number" formControlName="unitPrice" />
          </mat-form-field>
        </td>
        <td mat-footer-cell *matFooterCellDef></td>
      </ng-container>

      <ng-container matColumnDef="price">
        <th mat-header-cell *matHeaderCellDef>Precio</th>
        <td mat-cell *matCellDef="let row; let i = index" [formGroupName]="i">
          <mat-form-field appearance="outline">
            <input matInput readonly min="0.1" type="number" formControlName="price" />
          </mat-form-field>
        </td>
        <td mat-footer-cell *matFooterCellDef>{{ totalPromotionsPrice | currency:'S/.':'symbol' }}</td>
      </ng-container>

      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef>Acciones</th>
        <td mat-cell *matCellDef="let row; let i = index">
          @if (orderPromotions.length > 1) {
          <button mat-icon-button color="warn" (click)="removePromotionItem(i)">
            <mat-icon>delete</mat-icon>
          </button>
          }
          @if (i === orderPromotions.length - 1) {
          <button mat-icon-button color="primary" (click)="addPromotionItem()" [disabled]="!row.valid">
            <mat-icon>add</mat-icon>
          </button>
          }
        </td>
        <td mat-footer-cell *matFooterCellDef></td>

      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumnsPromotions"></tr>
      <tr mat-row *matRowDef="let row; columns: displayedColumnsPromotions;"></tr>
      <tr mat-footer-row *matFooterRowDef="displayedColumnsPromotions"></tr>

    </table>
  </div>

</form>

<button mat-flat-button color="primary" (click)="submitOrder()" [disabled]="isSubmitDisabled()">
  Confirmar Pedido
</button>